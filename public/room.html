<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Zoom Clone - Room</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #222; color: white; }
    #videos { display: flex; flex-wrap: wrap; justify-content: center; padding: 1rem; gap: 1rem; }
    video { background: black; border-radius: 8px; width: 320px; height: 240px; object-fit: cover; }
    #roomInfo { padding: 1rem; text-align: center; background: #111; }
  </style>
</head>
<body>
  <div id="roomInfo"></div>
  <div id="videos"></div>

  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"
    integrity="sha384-03SN4TqSufUX/4yUbK+5CeEZWY79bhTiKhUJb9cUPbWiYv1S/fXQTQXpKfUcB+f2"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('roomId');
    const userName = urlParams.get('userName');

    if (!roomId || !userName) {
      alert('Room ID and user name are required.');
      window.location.href = '/';
    }

    const socket = io();

    const peers = {}; // Map peerId -> peer object

    const videos = document.getElementById('videos');
    const roomInfo = document.getElementById('roomInfo');
    roomInfo.textContent = `Room ID: ${roomId} | You are: ${userName}`;

    // Create our own video element
    const myVideo = document.createElement('video');
    myVideo.muted = true; // mute self to avoid echo

    // Get local media stream
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        addVideoStream(myVideo, stream);

        // Join room on backend signaling server
        socket.emit('join-room', { roomId, userName });

        // When a new user connects
        socket.on('user-connected', ({ id: userId, userName: remoteUserName }) => {
          console.log(`${remoteUserName} connected as ${userId}`);
          connectToNewUser(userId, stream);
        });

        // Receive signaling data
        socket.on('signal', ({ from, signal }) => {
          if (peers[from]) {
            peers[from].signal(signal);
          }
        });

        // When a user disconnects
        socket.on('user-disconnected', userId => {
          console.log('User disconnected:', userId);
          if (peers[userId]) {
            peers[userId].destroy();
            deletePeerVideo(userId);
            delete peers[userId];
          }
        });
      })
      .catch(err => {
        alert('Could not get media: ' + err);
      });

    function connectToNewUser(userId, stream) {
      // Create a new peer instance - not initiator because they joined after you
      const peer = new SimplePeer({ initiator: true, trickle: false, stream });

      peer.on('signal', signal => {
        socket.emit('signal', { signal, to: userId });
      });

      peer.on('stream', remoteStream => {
        const video = document.createElement('video');
        video.id = 'peerVideo-' + userId;
        addVideoStream(video, remoteStream);
      });

      peer.on('close', () => {
        deletePeerVideo(userId);
      });

      peers[userId] = peer;
    }

    // Handle signals from other peers (for this client we're responder)
    socket.on('user-connected', ({ id }) => {
      // already handled above
    });

    // Add video element to DOM and play stream
    function addVideoStream(video, stream) {
      video.srcObject = stream;
      video.addEventListener('loadedmetadata', () => video.play());
      videos.appendChild(video);
    }

    // Remove video element for disconnected peer
    function deletePeerVideo(userId) {
      const video = document.getElementById('peerVideo-' + userId);
      if (video) {
        video.srcObject.getTracks().forEach(track => track.stop());
        video.remove();
      }
    }

    // Respond to incoming WebRTC offers (as non-initiator)
    socket.on('user-connected', ({ id }) => {
      // no code needed here (already handled)
    });

    // Listen for signaling data from peers and respond
    socket.on('signal', ({ from, signal }) => {
      if (!peers[from]) {
        // Create peer as responder
        navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
          const peer = new SimplePeer({ initiator: false, trickle: false, stream });

          peer.on('signal', s => {
            socket.emit('signal', { signal: s, to: from });
          });

          peer.on('stream', remoteStream => {
            const video = document.createElement('video');
            video.id = 'peerVideo-' + from;
            addVideoStream(video, remoteStream);
          });

          peer.on('close', () => {
            deletePeerVideo(from);
          });

          peer.signal(signal);
          peers[from] = peer;
        });
      } else {
        peers[from].signal(signal);
      }
    });
  </script>

</body>
</html>
